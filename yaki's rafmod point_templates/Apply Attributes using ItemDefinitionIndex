///////////////////////////////////////////////////
/// Apply Attributes using ItemDefinition IDs	///
/// Sign Date: 16 Dec 21						///
/// Requested by: Space Jockey					///
/// Special Thanks: Mince						///
///////////////////////////////////////////////////

//What does this file teach us?
// Items can be altered beyond placing attributes onto them.
// + This example turns the Soldier's Buff Banner backpack into the Cold Case from the Engineer.
// + Additionally, we learn how to modify the Medic's Ubercharge value.

//How does this work?
// Each item has their own ID, found in items_game.txt (directory: /tf/scripts/items/).
// This ID is used to address the weapon via filter, called "$filter_sendprop".
// "$filter_sendprop" is a custom entity only found in Rafmod. It's used to filter stored values for entities (i.e. Decapitation values, Rage values, weapon states, etc).
// What happens here is we filter the "m_iItemDefinitionIndex", or the ID found in items_game, using "$filter_sendprop".
// We find the weapon with the ID that matches by TestActivator via @c@!activator, and apply attributes if the filter passes.

/////////////////
/// LESSON #1 ///////////////////////////////
/// Soldier's Buff Banner turns Cold Case ///
/////////////////////////////////////////////

/// It starts here. The logic is spawned into the map using this SpawnTemplate.
/// If you want to use this your entire mission, place this under your WaveSpawn,
/// OR if you want to only use this in one wave, place this in the Wave brackets.
/// This will make sure your filters are all in your map.
	SpawnTemplate
	{
		Name "initialize_logic_apply_weapon_attributes_cold_case"
	}
	
/// This point template finds the tf_wearable on Soldier, and applies the attributes to it.
/// This one does a $SetModelOverride to change the model.
/// Note 1: You can do anything here--Change ammo types, clip size, color, renderfx, models, etc. This example just changes models.
/// Note 2: Every single "tf_wearable" entity uses the ID "65535".
	PointTemplates
	{
		initialize_logic_apply_weapon_attributes_cold_case
		{
			NoFixup 1	//IMPORTANT!!

			$filter_sendprop		//The Buff Banner -> Cold case
			{
				"targetname" "rafmod_filter_weapon_setmodel_cold_case_soldier"
				"$name"	"m_iItemDefinitionIndex"
				"$value" "65535"
				"OnPass" "!activator,$SetModelOverride,models/workshop/player/items/engineer/spr18_cold_case/spr18_cold_case.mdl,0,-1"
			}
		}
	}
	
/// This template is spawned every time the Buff Banner is found equipped on a player.
/// If you want to use this your entire mission, place this under your WaveSpawn,
/// OR if you want to only use this in one wave, place this in the Wave brackets.
	PlayerItemEquipSpawnTemplate
	{
		Name "equip_banner_cold_case"
		ItemName "The Buff Banner"
	}
	
/// Further PointTemplates. This example separates the templates, but you may keep them together in your pop file.
/// This template (equip_banner_cold_case) will test for Soldier, then test all child entities, addoutput OnUser1 to them, and Test them using $FireUserAsActivator1.
/// What a mouthful!
	PointTemplates
	{
		equip_banner_cold_case
		{
			OnSpawnOutput
			{
				Target "rafmod_filter_weapon_setmodel_cold_case_soldier"
				Action "TestActivator"
				Delay 0.01
			}
			filter_tf_class
			{
				"targetname" "rafmod_filter_weapon_setmodel_cold_case_soldier"
				"tfclass" "3"
				"OnPass" "@c@!activator,$SetKey$solid,2,0,1"	//sets tf_wearable to Solid 2 so it passes. Don't ask me why this works.
				"OnPass" "@c@!activator,AddOutput,OnUser1 rafmod_filter_weapon_setmodel_cold_case_soldier:TestActivator::0:1,0.1,1"
				"OnPass" "@c@!activator,$FireUserAsActivator1,,0.2,1"
			}
			OnSpawnOutput
			{
				Target "rafmod_filter_weapon_setmodel_cold_case_soldier"
				Action "Kill"
				Delay 0.1
			}
			RemoveIfKilled "rafmod_filter_weapon_setmodel_cold_case_soldier"
		}
	}
	
	
/////////////////
/// LESSON #2 /////////////////////////
/// Modify Medic's Ubercharge Rates ///
///////////////////////////////////////
	
/// This PlayerSpawnTemplate spawns every time the player changes classes.
/// If you want to use this your entire mission, place this under your WaveSpawn,
/// OR if you want to only use this in one wave, place this in the Wave brackets.
	PlayerSpawnTemplate
	{
		Name "player_attributes_onspawn"
	}
	
/// This works like lesson #1, but every time the player spawns.
/// + This sends the value of the "m_iItemDefinitionIndex" to a logic_case to be tested.
/// + The logic_cases MUST be spawned with "NoFixup 1" and be in the map beforehand.
	PointTemplates
	{
		player_attributes_onspawn
		{
			OnSpawnOutput
			{
				Target "@c@!activator"		//fires to the children of the parent, !activator.
				Action "$GetProp$m_iItemDefinitionIndex"	//Grabs the prop value for ItemDefinitionIndex (items_game value).
				Param "rafmod_case_weapon_ItemDefinitionIndex|InValue|"		//sends value to a logic_case
				Delay 0.01
			}
		}
	}
	
/// This will spawn into the map to initialize the logic for the next part.
/// If you want to use this your entire mission, place this under your WaveSpawn,
/// OR if you want to only use this in one wave, place this in the Wave brackets.
	SpawnTemplate
	{
		Name "initialize_logic_apply_weapon_attributes"
	}
	
/// Next part credit to Mince:
/// This uses logic_cases to send the m_iItemDefinitionIndex, and if they match, triggers a relay to modify the Ubercharge level.

	PointTemplates
	{
		initialize_logic_apply_weapon_attributes
		{
			NoFixup 1	//IMPORTANT!!
			
	/// These two logic_cases hold the values for every single type of Medigun.
	/// When they pass, they trigger a relay to change the charge level. (very bottom of this lesson)
			logic_case
			{
				"targetname" "rafmod_case_weapon_ItemDefinitionIndex"
				"Case01"	"35"		//The Kritzkrieg
				"Case02"	"411"		//The Quick-Fix
				"Case03"	"998"		//The Vaccinator
				"Case04"	"29"		//Stock TF_WEAPON_MEDIGUN
				"Case05"	"211"		//Upgradeable TF_WEAPON_MEDIGUN
				"Case06"	"663"		//Festive Medigun 2011
				"Case07"	"796"		//Silver Botkiller Medi Gun Mk.I
				"Case08"	"805"		//Gold Botkiller Medi Gun Mk.I
				"Case09"	"885"		//Rust Botkiller Medi Gun Mk.I
				"Case10"	"894"		//Blood Botkiller Medi Gun Mk.I
				"Case11"	"903"		//Carbonado Botkiller Medi Gun Mk.Iv
				"Case12"	"912"		//Diamond Botkiller Medi Gun Mk.I
				"Case13"	"961"		//Silver Botkiller Medi Gun Mk.II
				"Case14"	"970"		//Gold Botkiller Medi Gun Mk.II
				
				"OnCase01" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase02" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase03" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase04" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase05" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase06" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase07" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase08" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase09" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase10" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase11" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase12" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase13" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase14" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
			}
			logic_case
			{
				"targetname" "rafmod_case_weapon_ItemDefinitionIndex"
				"Case01"	"15008"		//concealedkiller_medigun_maskedmender
				"Case02"	"15010"		//concealedkiller_medigun_wrappedreviver
				"Case03"	"15025"		//craftsmann_medigun_reclaimedreanimator
				"Case04"	"15039"		//teufort_medigun_civilservant
				"Case05"	"15050"		//powerhouse_medigun_sparkoflife
				"Case06"	"15078"		//harvest_medigun_wildwood
				"Case07"	"15097"		//pyroland_medigun_flowerpower
				"Case08"	"15120"		//gentlemanne_medigun_coffinnail
				"Case09"	"15121"		//gentlemanne_medigun_dressedtokill
				"Case10"	"15122"		//gentlemanne_medigun_highrollers
				"Case11"	"15145"		//warbird_medigun_blitzkrieg
				"Case12"	"15146"		//warbird_medigun_corsair
				
				"OnCase01" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase02" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase03" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase04" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase05" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase06" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase07" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase08" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase09" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase10" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase11" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
				"OnCase12" "!activator,rafmod_relay_set_medigun_charge,Trigger,,0,-1"
			}
			
	/// A relay organizes all medigun charges to become the same value
	/// We're looking at the prop "m_flChargeLevel" here...
			logic_relay
			{
				"targetname" "rafmod_relay_set_medigun_charge"
				"OnTrigger" "!activator,$SetProp$m_flChargeLevel,1,0,-1"	//1 == 100% charge. Can go over or under via forcing the number.
			}
		}
	}
